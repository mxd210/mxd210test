<!-- REPLACE WHOLE FILE: /tools/botbuyauto-test.html --> 
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MXD BotBuyAuto – Test kéo sản phẩm & publish JSON 3.5</title>
  <meta name="robots" content="noindex,follow"/>
  <style>
    :root{
      --bg:#050816;
      --panel:#111827;
      --accent:#38bdf8;
      --accent-soft:rgba(56,189,248,0.12);
      --border:#1f2933;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --danger:#f87171;
      --ok:#4ade80;
      --warn:#facc15;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#111827 0,#020617 55%,#000 100%);
      color:var(--text);
      padding:16px;
    }
    .wrap{max-width:1080px;margin:0 auto;}
    h1{font-size:1.6rem;margin:0 0 12px;}
    p{margin:4px 0;color:var(--muted);font-size:0.92rem;}
    .grid{
      display:grid;
      grid-template-columns:1.1fr 1fr;
      gap:16px;
      margin-top:16px;
    }
    .panel{
      background:var(--panel);
      border-radius:12px;
      border:1px solid var(--border);
      padding:14px 16px;
      box-shadow:0 20px 40px rgba(0,0,0,0.45);
    }
    .panel h2{font-size:1.05rem;margin:0 0 8px;}
    label{display:block;font-size:0.85rem;color:var(--muted);margin-bottom:4px;}
    input,select,textarea{
      width:100%;
      padding:7px 9px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--text);
      font-size:0.9rem;
      outline:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }
    textarea{
      min-height:140px;
      resize:vertical;
      font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      white-space:pre;
    }
    #preview{
      min-height:260px;
    }
    @media(min-width:900px){
      #preview{
        min-height:360px;
      }
    }
    .row{display:flex;gap:10px;margin-bottom:10px;}
    .row > div{flex:1;}
    .btn-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;}
    button{
      border:none;border-radius:999px;
      padding:7px 14px;
      font-size:0.9rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:var(--accent-soft);
      color:var(--accent);
    }
    button.primary{
      background:var(--accent);
      color:#0b1120;
      font-weight:600;
    }
    button[disabled]{opacity:0.55;cursor:default;}
    .tag{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:0.78rem;
      color:var(--muted);
      gap:4px;
    }
    .tag-dot{width:7px;height:7px;border-radius:999px;background:var(--accent);}
    .status{margin-top:6px;font-size:0.84rem;}
    .status.ok{color:var(--ok);}
    .status.err{color:var(--danger);}
    .status.warn{color:var(--warn);}
    code{
      font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:0.8rem;
      background:#020617;
      padding:2px 4px;
      border-radius:4px;
    }
    ul.micro{
      margin:4px 0 0 1rem;
      padding:0;
      font-size:0.8rem;
      color:var(--muted);
    }
    ul.micro li{margin:1px 0;}
    @media(max-width:860px){.grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>MXD BotBuyAuto – Test kéo sản phẩm & publish JSON</h1>
    <p>Công cụ test nội bộ: chọn campaign, domain, mã ngành (cate) và số lượng, sau đó bấm để Worker gọi AccessTrade, chuẩn hoá schema MXD và ghi vào <code>data/affiliates.json</code> của repo test.</p>

    <div class="grid">
      <!-- FORM -->
      <div class="panel">
        <h2>Cấu hình & thao tác</h2>

        <div class="row">
          <div>
            <label for="workerBase">Worker base URL</label>
            <input id="workerBase" type="text"
                   value="https://testbotbuy.mxd6686.workers.dev"
                   autocomplete="off"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="campaign">Campaign (sàn)</label>
            <select id="campaign">
              <option value="shopee">shopee</option>
              <option value="lazada" selected>lazada</option>
              <option value="tiki">tiki</option>
              <option value="tiktok">tiktok</option>
              <option value="mediamart">mediamart</option>
            </select>
          </div>
          <div>
            <label for="domain">Domain</label>
            <input id="domain" type="text" value="lazada.vn" autocomplete="off"/>
          </div>
          <div>
            <label for="limit">Số lượng (1–50)</label>
            <input id="limit" type="number" min="1" max="50" value="5"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="atCate">AT cate (mã ngành hàng)</label>
            <input id="atCate" type="text"
                   placeholder="vd: cong-nghe, dien-thoai-may-tinh-bang, thiet-bi-gia-dung"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="categorySlug">Category slug MXD (đặt tên kệ hàng)</label>
            <input id="categorySlug" type="text"
                   placeholder="vd: do-dien-tu, do-gia-dung, thoi-trang-nu"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="targetPath">File JSON trong repo</label>
            <input id="targetPath" type="text" value="data/affiliates.json"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="commitMessage">Commit message</label>
            <input id="commitMessage" type="text"
                   value="botbuyauto: publish from tool"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label><input id="dryRun" type="checkbox"/> Chỉ dry run (không ghi repo)</label>
          </div>
        </div>

        <div class="btn-row">
          <button id="btnFetch" type="button">
            <span>1) Lấy sản phẩm (fetch)</span>
          </button>
          <button id="btnPublish" type="button" class="primary">
            <span>2) Publish JSON lên repo</span>
          </button>
          <span class="tag">
            <span class="tag-dot"></span>
            <span id="tagInfo">Chưa có dữ liệu</span>
          </span>
        </div>

        <div id="status" class="status"></div>

        <ul class="micro">
          <li><b>AT cate</b> là mã ngành của AccessTrade (không phải slug MXD), ví dụ:
            <code>cong-nghe</code>, <code>dien-thoai-may-tinh-bang</code>,
            <code>thiet-bi-gia-dung</code>, <code>health_and_beauty</code>…</li>
          <li><b>Category slug MXD</b> là tên kệ của Mai (vd: <code>do-dien-tu</code>), sẽ ghi vào field <code>category</code> trong JSON.</li>
          <li>Ảnh: nếu item chưa có <code>image</code> nhưng có <code>sku</code>, tool sẽ mặc định dùng đường dẫn local <code>/assets/img/products/&lt;sku&gt;.webp</code>.</li>
        </ul>
      </div>

      <!-- PREVIEW -->
      <div class="panel">
        <h2>Preview dữ liệu</h2>
        <p style="margin-bottom:6px;">Xem nhanh các sản phẩm sẽ được publish (tối đa 50). Đây chỉ là preview để kiểm tra tên, giá, origin, sku, cate…</p>
        <textarea id="preview" readonly placeholder="Chưa có dữ liệu. Bấm &quot;Lấy sản phẩm&quot; để xem."></textarea>
      </div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);

    const workerBaseEl   = $('#workerBase');
    const campaignEl     = $('#campaign');
    const domainEl       = $('#domain');
    const limitEl        = $('#limit');
    const atCateEl       = $('#atCate');
    const categorySlugEl = $('#categorySlug');
    const targetPathEl   = $('#targetPath');
    const commitMsgEl    = $('#commitMessage');
    const dryRunEl       = $('#dryRun');
    const btnFetch       = $('#btnFetch');
    const btnPublish     = $('#btnPublish');
    const previewEl      = $('#preview');
    const statusEl       = $('#status');
    const tagInfoEl      = $('#tagInfo');

    let currentItems = [];

    // auto sync domain theo campaign
    campaignEl.addEventListener('change', () => {
      const c = campaignEl.value;
      if (c === 'shopee') domainEl.value = 'shopee.vn';
      else if (c === 'lazada') domainEl.value = 'lazada.vn';
      else if (c === 'tiki') domainEl.value = 'tiki.vn';
      else if (c === 'tiktok') domainEl.value = 'tiktok.com';
      else if (c === 'mediamart') domainEl.value = 'mediamart.vn';
    });

    function setLoading(isLoading) {
      btnFetch.disabled = isLoading;
      btnPublish.disabled = isLoading;
    }

    function setStatus(text, level = 'info') {
      statusEl.textContent = text || '';
      statusEl.className = 'status ' + (
        level === 'ok' ? 'ok' :
        level === 'err' ? 'err' :
        level === 'warn' ? 'warn' : ''
      );
    }

    function updateTag() {
      if (!currentItems || !currentItems.length) {
        tagInfoEl.textContent = 'Chưa có dữ liệu';
      } else {
        tagInfoEl.textContent = `${currentItems.length} sản phẩm đang chờ publish`;
      }
    }

    function humanMerchantLabel(m) {
      const v = (m || '').toLowerCase();
      if (v === 'shopee') return 'Shopee';
      if (v === 'lazada') return 'Lazada';
      if (v === 'tiki') return 'Tiki';
      if (v === 'tiktok') return 'TikTok Shop';
      if (v === 'mediamart') return 'MediaMart';
      return 'sàn thương mại điện tử';
    }

    function formatVnd(n) {
      const num = Number(n) || 0;
      if (!num) return 'giá tốt';
      return new Intl.NumberFormat('vi-VN').format(num) + '₫';
    }

    function buildTagsFromName(name) {
      const text = (name || '').toLowerCase();
      const noAccents = text
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
      const cleaned = noAccents.replace(/[^a-z0-9\s]+/g, ' ');
      const parts = cleaned.split(/\s+/).filter(w => w.length > 1 && w.length <= 15);
      const seen = new Set();
      const tags = [];
      for (const w of parts) {
        if (!seen.has(w)) {
          seen.add(w);
          tags.push(w);
          if (tags.length >= 12) break;
        }
      }
      return tags;
    }

    function buildSeoFields(item, categorySlug, campaign) {
      const name = (item.name || '').toString().trim();
      const priceText = formatVnd(item.price);
      const merchantLabel = humanMerchantLabel(item.merchant || campaign);
      const cat = categorySlug || item.category || '';
      const catLabel = cat ? cat.replace(/-/g,' ') : 'ưu đãi';

      const shortDesc =
        `${name} – lựa chọn phù hợp cho bạn với ${priceText}. ` +
        `Đặt mua online trên ${merchantLabel} qua MXD.`;

      const seoTitle = `${name} | ${catLabel} | MXD`;

      const seoDescription =
        `${name} do MXD chọn lọc, phù hợp nhu cầu sử dụng hàng ngày. ` +
        `Giá tham khảo khoảng ${priceText}. ` +
        `Đặt mua trên ${merchantLabel} qua liên kết affiliate MXD. ` +
        shortDesc;

      const tags = buildTagsFromName(name);

      return { short_desc: shortDesc, seo_title: seoTitle, seo_description: seoDescription, tags };
    }

    async function doFetch() {
      const base = workerBaseEl.value.trim().replace(/\/+$/,'');
      const campaign = campaignEl.value.trim();
      const domain = domainEl.value.trim();
      let limit = parseInt(limitEl.value, 10);
      if (!Number.isFinite(limit) || limit < 1) limit = 5;
      if (limit > 50) limit = 50;
      limitEl.value = String(limit);

      const atCate = atCateEl.value.trim();

      if (!base) { setStatus('Thiếu Worker base URL.', 'err'); return; }
      if (!campaign) { setStatus('Thiếu campaign.', 'err'); return; }

      const url = new URL(base + '/auto/fetch');
      url.searchParams.set('campaign', campaign);
      if (domain) url.searchParams.set('domain', domain);
      url.searchParams.set('limit', String(limit));
      if (atCate) url.searchParams.set('cate', atCate);  // gửi cate xuống Worker

      setLoading(true);
      setStatus('Đang gọi /auto/fetch…', 'info');
      previewEl.value = '';

      try {
        const resp = await fetch(url.toString());
        const data = await resp.json();
        if (data.state !== 'ok') {
          console.error(data);
          setStatus('Fetch lỗi: ' + (data.message || data.code || resp.status), 'err');
          currentItems = [];
          updateTag();
          return;
        }

        const items = Array.isArray(data.items) ? data.items : [];
        currentItems = items;
        updateTag();

        const srcTotal = typeof data.total === 'number'
          ? data.total
          : (typeof data.count === 'number' ? data.count : items.length);
        const usedFallback = !!data.used_fallback;

        const cateSet = new Set(
          items
            .map(it => it.category)
            .filter(v => typeof v === 'string' && v.trim())
        );
        const cateList = Array.from(cateSet);

        let msg = '';
        if (usedFallback && atCate) {
          msg = `Không có sản phẩm nào với cate="${atCate}" trên AccessTrade. ` +
                `Đang dùng ${items.length} sản phẩm fallback (không lọc cate).`;
        } else if (atCate) {
          msg = `AccessTrade trả ${srcTotal} sản phẩm, đang dùng ${items.length} sản phẩm (cate gửi lên: "${atCate}").`;
        } else {
          msg = `AccessTrade trả ${srcTotal} sản phẩm, đang dùng ${items.length} sản phẩm (không lọc cate).`;
        }

        if (cateList.length) {
          msg += ` Cate thấy trong kết quả: ${cateList.slice(0, 6).join(', ')}.`;
        }

        setStatus(msg, items.length ? 'ok' : 'warn');

        const previewObj = currentItems.map((it, idx) => ({
          idx: idx + 1,
          name: it.name,
          price: it.price,
          origin: it.origin,
          merchant: it.merchant,
          sku: it.sku,
          cate_from_at: it.category
        }));
        previewEl.value = JSON.stringify(previewObj, null, 2);
      } catch (err) {
        console.error(err);
        setStatus('Lỗi khi gọi /auto/fetch. Xem console để biết chi tiết.', 'err');
        currentItems = [];
        updateTag();
      } finally {
        setLoading(false);
      }
    }

    async function doPublish() {
      if (!currentItems || !currentItems.length) {
        setStatus('Chưa có dữ liệu để publish. Hãy bấm "Lấy sản phẩm" trước.', 'warn');
        return;
      }

      const base = workerBaseEl.value.trim().replace(/\/+$/,'');
      if (!base) {
        setStatus('Thiếu Worker base URL.', 'err');
        return;
      }

      const targetPath   = targetPathEl.value.trim() || 'data/affiliates.json';
      const commitMsg    = commitMsgEl.value.trim() || 'botbuyauto: publish';
      const campaign     = campaignEl.value.trim();
      const categorySlug = categorySlugEl.value.trim();
      const dryRun       = !!dryRunEl.checked;

      const items = currentItems.map(it => {
        // Chuẩn hóa item theo schema MXD
        const baseItem = {
          name: (it.name || '').toString(),
          price: Number(it.price) || 0,
          origin: (it.origin || it.url || '').toString(),
          merchant: (it.merchant || campaign || '').toString().toLowerCase(),
          sku: (it.sku || '').toString(),
          image: (it.image || '').toString(),
          category: (categorySlug || it.category || '').toString(),
          brand: (it.brand || '').toString(),
          featured: !!it.featured,
          status: it.status !== false,
          updated_at: (it.updated_at || new Date().toISOString()).toString(),
          deeplink: (it.deeplink || '').toString(),
          sub1: (it.sku || it.sub1 || '').toString(),
          short_desc: (it.short_desc || '').toString(),
          seo_title: (it.seo_title || '').toString(),
          seo_description: (it.seo_description || '').toString(),
          tags: Array.isArray(it.tags) ? it.tags.slice(0, 20) : []
        };

        if (!baseItem.image && baseItem.sku) {
          baseItem.image = `/assets/img/products/${baseItem.sku}.webp`;
        }

        const seoFields = buildSeoFields(baseItem, categorySlug, campaign);
        baseItem.short_desc      = seoFields.short_desc;
        baseItem.seo_title       = seoFields.seo_title;
        baseItem.seo_description = seoFields.seo_description;
        baseItem.tags            = seoFields.tags;

        baseItem.sub2 = 'mxd210';
        baseItem.sub3 = 'botbuyauto';
        baseItem.sub4 = categorySlug || campaign || '';

        return baseItem;
      });

      if (!dryRun) {
        const ok = window.confirm(`Publish ${items.length} sản phẩm vào "${targetPath}"?`);
        if (!ok) return;
      }

      setLoading(true);
      setStatus(
        dryRun
          ? 'Đang gửi /auto/publish (dry run)…'
          : 'Đang gửi /auto/publish để ghi repo…',
        'info'
      );

      try {
        const resp = await fetch(base + '/auto/publish', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            items,
            wrap: true,
            target_path: targetPath,
            commit_message: commitMsg,
            dry_run: dryRun
          })
        });
        const data = await resp.json();
        console.log('PUBLISH RESULT', data);

        if (data.state !== 'ok') {
          setStatus('Publish lỗi: ' + (data.message || data.code || resp.status), 'err');
          return;
        }

        if (dryRun) {
          setStatus(
            `Dry run OK, ${data.preview?.items?.length || items.length} sản phẩm. File: ${targetPath}`,
            'ok'
          );
          previewEl.value = JSON.stringify(data.preview, null, 2);
        } else {
          setStatus(
            `Publish thành công ${data.count || items.length} sản phẩm vào ${targetPath}.`,
            'ok'
          );
        }
      } catch (err) {
        console.error(err);
        setStatus('Lỗi khi gọi /auto/publish. Xem console để biết chi tiết.', 'err');
      } finally {
        setLoading(false);
      }
    }

    btnFetch.addEventListener('click', () => { doFetch(); });
    btnPublish.addEventListener('click', () => { doPublish(); });

    updateTag();
  </script>
</body>
</html>
